{% extends 'base.html' %}
{% block content %}
<div class="container mt-5 text-center">
    <h2 class="mb-4">Уникальные иероглифы</h2>

    <div class="mb-4 d-flex justify-content-center gap-3">
        <button id="copy-button" class="btn btn-success">Копировать всё</button>
        <button id="copy-selected-button" class="btn btn-warning">Копировать выбранные</button>
        <button id="clear-checkboxes-button" class="btn btn-danger">Очистить чекбоксы</button>
        <button id="download-selected-button" class="btn btn-primary">Скачать выбранные в Word</button>
        <a href="{{ url_for('download') }}" class="btn btn-info">Скачать все в Word</a>
    </div>

    <form id="character-form">
        <ol id="character-list" class="list-group mx-auto" style="max-width: 400px;">
            {% for index, char in enumerate(characters, start=1) %}
                <li class="list-group-item">
                    <label class="checkbox-container">
                        <input type="checkbox" class="custom-checkbox" name="selected_chars" value="{{ char }}">
                        <span class="checkmark"></span>
                    </label>
                    <span class="character-text">{{ index }}. {{ char }}</span>
                </li>
            {% endfor %}
        </ol>
    </form>

    <div class="mt-4">
        <a href="{{ url_for('clear') }}" class="btn btn-danger">Очистить все слова</a>
    </div>
</div>

<script>
    // Функция для копирования всех уникальных иероглифов
    document.getElementById('copy-button').addEventListener('click', function() {
        const allCharacters = Array.from(document.querySelectorAll('.character-text'))
                                   .map(el => el.textContent.trim());

        // Создаем текстовое представление иероглифов
        const textToCopy = allCharacters.join('\n');

        // Используем Clipboard API для копирования
        navigator.clipboard.writeText(textToCopy).then(function() {
            alert('Все иероглифы скопированы в буфер обмена!');
        }, function(err) {
            console.error('Ошибка копирования: ', err);
        });
    });

    // Функция для копирования выбранных иероглифов
    document.getElementById('copy-selected-button').addEventListener('click', function() {
        const selectedCharacters = Array.from(document.querySelectorAll('input[name="selected_chars"]:checked'))
                                        .map(checkbox => checkbox.nextElementSibling.parentElement.nextElementSibling.textContent.trim());

        // Проверяем, выбраны ли символы
        if (selectedCharacters.length === 0) {
            alert('Пожалуйста, выберите хотя бы один иероглиф для копирования.');
            return;
        }

        const textToCopy = selectedCharacters.join('\n');

        // Копируем выбранные символы в буфер обмена
        navigator.clipboard.writeText(textToCopy).then(function() {
            alert('Выбранные иероглифы скопированы в буфер обмена!');
        }, function(err) {
            console.error('Ошибка копирования: ', err);
        });
    });

    // Функция для очистки чекбоксов
    document.getElementById('clear-checkboxes-button').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('input[name="selected_chars"]');
        checkboxes.forEach(checkbox => checkbox.checked = false);
        alert('Все чекбоксы очищены!');
    });

    // Функция для скачивания выбранных иероглифов в Word
    document.getElementById('download-selected-button').addEventListener('click', function() {
        const selectedCharacters = Array.from(document.querySelectorAll('input[name="selected_chars"]:checked'))
                                        .map(checkbox => checkbox.value);

        fetch('/download_selected', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ characters: selectedCharacters })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Не выбраны символы');
            }
            return response.blob();
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'selected_characters.docx';
            document.body.appendChild(a);
            a.click();
            a.remove();
        })
        .catch(error => {
            alert(error.message);
        });
    });
</script>
{% endblock %}
